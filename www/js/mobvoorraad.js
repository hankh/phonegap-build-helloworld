// Generated by CoffeeScript 1.6.3
/*
@license
Copyright 2013 Harena Automatisering
mobVoorraad-module tbv webshop
*/


(function() {
  var afrondenorder, aorder, aproduct, bestel, bevestigorder, curproduct, orderbedrag, ordernr, orderstelen, toonproduct, tovoorraadpage, updateorder, updatevoorraad, vwbestel;

  aproduct = [];

  aorder = [];

  curproduct = 0;

  orderstelen = 0;

  orderbedrag = 0;

  ordernr = 0;

  toonproduct = function(nr) {
    var buttons, clengte, cvoorraad, max, prod, x, _i;
    curproduct = nr;
    prod = aproduct[nr];
    cvoorraad = prod.aantal.toString() + " x " + prod.inhoud.toString();
    if (prod.lengte > 0) {
      clengte = prod.lengte.toString() + " cm";
    } else {
      clengte = "";
    }
    $("#voorraad").html(cvoorraad);
    $("#product").html(prod.oms);
    $("#lengte").html(clengte);
    $("#herkomst").html(prod.lev + ' ' + prod.land + " " + prod.mps);
    $("#kleur").html(prod.kleur);
    $("#prijs").html(prod.prijs.format(2, '.', ','));
    if (prod.aantal > 10) {
      max = 10;
    } else {
      max = prod.aantal;
    }
    buttons = "";
    for (x = _i = 1; 1 <= max ? _i <= max : _i >= max; x = 1 <= max ? ++_i : --_i) {
      buttons = buttons + '<button class="bestelbutton" data-inline="true" data-mini="true" onclick="bestel(' + x.toString() + ');">' + x.toString() + 'x</button>';
    }
    $("#tebestellen").html(buttons);
    $(".bestelbutton").buttonMarkup();
    $("#besteld").html("");
    jQuery.mobile.changePage("#page2");
    return true;
  };

  updatevoorraad = function() {
    $.getJSON("/xdata/voorraad/", function(data) {
      var aregels, kleur, land, lengte, n, oms, prijs, prod, reg, s, voorraad, _i, _len, _results;
      aregels = data.results;
      s = '';
      n = 0;
      $("#vlijst").empty();
      aproduct = [];
      _results = [];
      for (_i = 0, _len = aregels.length; _i < _len; _i++) {
        reg = aregels[_i];
        prod = {
          nr: reg.nr,
          oms: reg.oms,
          aantal: reg.aantal,
          inhoud: reg.inhoud,
          prijs: reg.verkprijs,
          lengte: reg.lengte,
          kleur: reg.kleur,
          lev: reg.levkode,
          land: reg.land,
          mps: reg.mpsmerk
        };
        aproduct.push(prod);
        voorraad = "" + (reg.aantal.toString()) + " x  " + (reg.inhoud.toString());
        oms = reg.oms.replace("Roos ", "R.");
        lengte = reg.lengte;
        kleur = reg.kleur;
        land = reg.land;
        prijs = reg.verkprijs.format(2, '.', ',');
        s = '<li><a href="javascript:toonproduct(' + n.toString() + ');">' + voorraad + ' ' + oms + ' ' + lengte + ' ' + kleur + ' ' + land + ' ' + prijs + '</a></li>';
        $("#vlijst").append(s);
        $("#vlijst").listview('refresh');
        _results.push(n = n + 1);
      }
      return _results;
    });
    tovoorraadpage();
    return true;
  };

  tovoorraadpage = function() {
    jQuery.mobile.changePage("#page1");
    return true;
  };

  bestel = function(bestaantal) {
    var curaantal, nr, pars, prod, vprijs;
    curaantal = bestaantal.toNumber();
    if (curaantal > 0) {
      prod = aproduct[curproduct];
      nr = prod.nr;
      vprijs = prod.prijs;
      pars = {
        "nr": nr,
        "vprijs": vprijs,
        "aantal": curaantal
      };
      $.get("/gh/voorraadbestel/", pars, function(data) {
        return vwbestel(data);
      });
    } else {
      alert("Geef aantal");
    }
    return true;
  };

  vwbestel = function(data) {
    var aantal, buttons, clist, cresp, nr, nwvoorraad;
    cresp = data;
    clist = cresp.split('|');
    if (clist[0] === "ok") {
      nr = clist[2];
      ordernr = clist[3];
      nwvoorraad = clist[4];
      aantal = clist[5];
      $("#besteld").html("<h2>besteld: " + aantal + "</h2>");
      buttons = "";
      buttons = buttons + '<button class="bestelbutton" data-inline="true" data-mini="true" onclick="updatevoorraad();">Voorraadlijst</button>';
      buttons = buttons + '<button class="bestelbutton" data-inline="true" data-mini="true" onclick="updateorder()">Toon order</button>';
      $("#tebestellen").html(buttons);
      $(".bestelbutton").buttonMarkup();
    } else {
      alert("bestelling niet mogelijk " + clist[1]);
    }
  };

  updateorder = function() {
    $.getJSON("/xdata/order/", function(data) {
      var aregels, besteld, lengte, n, oms, ordreg, prijs, reg, s, _i, _len, _results;
      aregels = data.regels;
      s = '';
      n = 0;
      orderbedrag = data.subtotaal;
      orderstelen = data.stelen;
      ordernr = data.ordernr;
      $("#ordertitel").html("Order nr: " + ordernr);
      aorder = [];
      $("#olijst").empty();
      _results = [];
      for (_i = 0, _len = aregels.length; _i < _len; _i++) {
        reg = aregels[_i];
        ordreg = {
          nr: reg.nr,
          oms: reg.artoms,
          aantal: reg.aantal,
          inhoud: reg.inhoud,
          prijs: reg.prijs,
          lengte: reg.lengte,
          kleur: reg.kleur,
          lev: reg.levkode,
          land: reg.land,
          mps: reg.mpsmerk,
          bedrag: reg.bedrag
        };
        aorder.push(ordreg);
        besteld = "" + (reg.aantal.toString()) + " x  " + (reg.inhoud.toString());
        oms = reg.artoms;
        lengte = reg.lengte;
        prijs = reg.prijs.format(2, '.', ',');
        s = '<li><a href="javascript:toonordreg(' + n.toString() + ');">' + besteld + ' ' + oms + ' ' + lengte + ' ' + prijs + '</a></li>';
        $("#olijst").append(s);
        $("#olijst").listview('refresh');
        _results.push(n = n + 1);
      }
      return _results;
    });
    jQuery.mobile.changePage("#orderpage");
    return true;
  };

  afrondenorder = function() {
    var bevestigbutton;
    $("#ordernr").html(ordernr);
    $("#stelen").html(orderstelen);
    $("#bedrag").html(orderbedrag.format(2, ".", ","));
    bevestigbutton = '<button class="bestelbutton" data-inline="true" onclick="bevestigorder();">Bevestigorder</button>';
    $("#bevestig").html(bevestigbutton);
    jQuery.mobile.changePage("#afrondenpage");
  };

  bevestigorder = function() {
    return window.location = "/gh/bevestigorder/?ordernr=" + ordernr;
  };

  this.bevestigorder = bevestigorder;

  this.afrondenorder = afrondenorder;

  this.toonproduct = toonproduct;

  this.bestel = bestel;

  this.updatevoorraad = updatevoorraad;

  this.updateorder = updateorder;

}).call(this);
